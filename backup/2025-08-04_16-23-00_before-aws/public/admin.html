<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hantera Bed√∂mningsomr√•den</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1 id="course-title">Hantera Bed√∂mningsomr√•den</h1>
    <nav>
      <a href="/landing.html">Byt kurs</a>
      <a href="/restore.html">√Öterst√§ll Student</a>
      <a id="back-link" href="/">Tillbaka till huvudsidan</a>
    </nav>
  </header>

  <main class="admin-main">
    <div class="admin-section">
      <h2>Hantera Studenter</h2>
      <ul id="studentList" class="item-list"></ul>
      <div class="add-item-form">
        <h3>L√§gg till ny student</h3>
        <input type="text" id="newStudentName" placeholder="Studentens namn" />
        <button id="addStudentBtn">L√§gg till student</button>
      </div>
      <div id="backupPanel" class="add-item-form">
        <h3>S√§kerhetskopiering & Import</h3>
        <p>Exportera all studentdata till en JSON-fil f√∂r s√§kerhetskopiering. Importera fr√•n en s√•dan fil f√∂r att √•terst√§lla eller l√§gga till studenter.</p>
        <a id="export-link" href="/api/students/export" class="button-like">Exportera Allt</a>
        <div class="import-section">
            <label for="importFile">Importera fr√•n fil:</label>
            <input type="file" id="importFile" accept=".json">
            <button id="importBtn">Importera</button>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <h2>Hantera Bed√∂mningsomr√•den</h2>
      <ul id="areaList" class="item-list"></ul>
      <div class="add-item-form">
        <h3>L√§gg till nytt omr√•de</h3>
        <input type="text" id="newAreaName" placeholder="Kort namn (t.ex. Planering)" />
        <textarea id="newAreaDesc" placeholder="Fullst√§ndig beskrivning..."></textarea>
        <button id="addAreaBtn">L√§gg till omr√•de</button>
      </div>
    </div>

    <div class="admin-section">
      <h2>Kursinst√§llningar</h2>
      <div class="add-item-form">
        <label for="courseDisplayName">Visningsnamn:</label>
        <input type="text" id="courseDisplayName" placeholder="T.ex. Programmering 101" />
        <label>V√§lj f√§rg:</label>
        <div id="colorPalette" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
        <button id="saveCourseSettingsBtn">Spara inst√§llningar</button>
      </div>
    </div>

    <div class="admin-section danger-zone">
      <h2>Danger Zone</h2>
      <p>Den h√§r √•tg√§rden kan inte √•ngras. All data f√∂r den h√§r kursen kommer att raderas permanent.</p>
      <button id="delete-course-btn" class="danger">Ta bort den h√§r kursen</button>
    </div>
  </main>

  <div id="toastNotification" class="toast-notification"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const courseName = urlParams.get('course');

      if (!courseName) {
        window.location.href = '/landing.html';
        return;
      }

      document.title = `Admin: ${courseName}`;
      document.getElementById('course-title').textContent = `Admin: ${courseName}`;
      document.getElementById('back-link').href = `/?course=${courseName}`;
      document.getElementById('export-link').href = `/api/students/export?course=${courseName}`;

      // --- Toast Notification Function ---
      const toastNotification = document.getElementById('toastNotification');
      function showToast(message, isError = false) {
        toastNotification.textContent = message;
        toastNotification.style.backgroundColor = isError ? '#e74c3c' : '#333';
        toastNotification.classList.add('show');
        setTimeout(() => {
          toastNotification.classList.remove('show');
        }, 3000); // Hide after 3 seconds
      }

      // --- DOM Elements ---
      const studentList = document.getElementById('studentList');
      const newStudentNameInput = document.getElementById('newStudentName');
      const addStudentBtn = document.getElementById('addStudentBtn');
      const areaList = document.getElementById('areaList');
      const newAreaNameInput = document.getElementById('newAreaName');
      const newAreaDescInput = document.getElementById('newAreaDesc');
      const addAreaBtn = document.getElementById('addAreaBtn');
      const deleteCourseBtn = document.getElementById('delete-course-btn');

      const courseDisplayNameInput = document.getElementById('courseDisplayName');
      const colorPalette = document.getElementById('colorPalette');
      const saveCourseSettingsBtn = document.getElementById('saveCourseSettingsBtn');
      let selectedColor = ''; // To store the currently selected color

      const standardColors = [
        '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000',
        '#008000', '#000080', '#808000', '#800080', '#008080', '#C0C0C0', '#808080',
        '#000000'
      ];

      function createColorSwatches() {
        colorPalette.innerHTML = ''; // Clear existing swatches
        standardColors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.classList.add('color-swatch');
          swatch.style.backgroundColor = color;
          swatch.dataset.color = color;
          swatch.style.width = '30px';
          swatch.style.height = '30px';
          swatch.style.border = '1px solid #ccc';
          swatch.style.cursor = 'pointer';
          swatch.style.borderRadius = '4px';
          swatch.addEventListener('click', () => {
            // Remove active class from all swatches
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            // Add active class to the clicked swatch
            swatch.classList.add('active');
            selectedColor = color;
          });
          colorPalette.appendChild(swatch);
        });
      }

      // --- Student Management ---
      async function loadStudents() {
        const res = await fetch(`/api/students?course=${courseName}`);
        const students = await res.json();
        students.sort((a, b) => a.name.localeCompare(b.name, 'sv'));

        studentList.innerHTML = '';
        students.forEach(student => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${student.name}</span>
            <button class="deleteStudentBtn" data-id="${student.id}" title="Ta bort student">üóëÔ∏è</button>
          `;
          studentList.appendChild(li);
        });
      }

      studentList.addEventListener('click', async (e) => {
        if (!e.target.matches('.deleteStudentBtn')) return;

        const btn = e.target;
        const studentId = btn.dataset.id;
        const studentName = btn.previousElementSibling.textContent;

        if (confirm(`√Ñr du s√§ker p√• att du vill ta bort studenten "${studentName}"?`)) {
          const res = await fetch(`/api/students/${studentId}?course=${courseName}`, { method: 'DELETE' });
          if (res.ok) {
            loadStudents();
          } else {
            showToast('Kunde inte ta bort studenten.', true);
          }
        } 
      });

      addStudentBtn.addEventListener('click', async () => {
        const name = newStudentNameInput.value.trim();
        if (!name) return showToast('Ange ett namn!', true);
        const res = await fetch(`/api/students?course=${courseName}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (res.ok) {
          newStudentNameInput.value = '';
          loadStudents();
        }
      });

      // --- Import/Export ---
      document.getElementById('importBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('importFile');
        if (fileInput.files.length === 0) {
          return showToast('V√§lj en fil att importera.', true);
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
          let importedStudents;
          try {
            importedStudents = JSON.parse(e.target.result);
            if (!Array.isArray(importedStudents)) {
              throw new Error('Filen inneh√•ller inte en lista med studenter.');
            }
          } catch (err) {
            return showToast(`Fel vid l√§sning av fil: ${err.message}`, true);
          }

          // --- Conflict Analysis ---
          const res = await fetch(`/api/students?course=${courseName}`);
          const currentStudents = await res.json();
          const currentStudentMap = new Map(currentStudents.map(s => [s.id, s]));

          const toAdd = [];
          const toOverwrite = [];

          importedStudents.forEach(imported => {
            if (currentStudentMap.has(imported.id)) {
              toOverwrite.push(imported.name);
            } else {
              toAdd.push(imported.name);
            }
          });

          let confirmMessage = '√Ñr du s√§ker p√• att du vill forts√§tta?\n\n';
          if (toAdd.length > 0) {
            confirmMessage += `Detta kommer l√§gga till ${toAdd.length} ny(a) student(er):\n- ${toAdd.join('\n- ')}\n\n`;
          }
          if (toOverwrite.length > 0) {
            confirmMessage += `Detta kommer SKRIVA √ñVER datan f√∂r ${toOverwrite.length} befintlig(a) student(er):\n- ${toOverwrite.join('\n- ')}\n\n`;
          }
          if (toAdd.length === 0 && toOverwrite.length === 0) {
            return showToast('Inga studenter att importera fr√•n filen.', true);
          }
          confirmMessage += 'Denna √•tg√§rd kan inte √•ngras.';

          if (confirm(confirmMessage)) {
            const importRes = await fetch(`/api/students/import?course=${courseName}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ students: importedStudents })
            });

            if (importRes.ok) {
              showToast('Importering lyckades!');
              loadStudents(); // Refresh the student list on the admin page
            } else {
              const errorData = await importRes.json();
              showToast(`Importering misslyckades: ${errorData.message || 'Ok√§nt fel.'}`, true);
            }
          }
        };

        reader.readAsText(file);
      });

      // --- Assessment Area Management ---
      async function loadAreas() {
        const res = await fetch(`/api/assessment-areas?course=${courseName}`);
        const areas = await res.json();

        areaList.innerHTML = '';
        areas.forEach((area, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="area-inputs">
              <input type="text" class="area-name-input" value="${area.name}" data-index="${index}" />
              <textarea class="area-desc-input" data-index="${index}">${area.description || ''}</textarea>
            </div>
            <div class="area-controls">
              <button class="moveUpBtn" data-index="${index}" title="Flytta upp">‚¨ÜÔ∏è</button>
              <button class="moveDownBtn" data-index="${index}" title="Flytta ner">‚¨áÔ∏è</button>
              <button class="deleteBtn" data-index="${index}" title="Ta bort">üóëÔ∏è</button>
            </div>
          `;
          areaList.appendChild(li);
        });
      }

      areaList.addEventListener('click', async (e) => {
        // We only care about clicks on buttons inside the list
        if (!e.target.matches('button')) return;

        const btn = e.target;
        const index = parseInt(btn.dataset.index);

        if (btn.classList.contains('deleteBtn')) {
          if (confirm('√Ñr du s√§ker p√• att du vill ta bort detta omr√•de? All data f√∂r detta omr√•de kommer att raderas f√∂r samtliga elever.')) {
            await fetch(`/api/assessment-areas/${index}?course=${courseName}`, { method: 'DELETE' });
            loadAreas();
          }
        } else if (btn.classList.contains('moveUpBtn')) {
          if (index > 0) {
            await fetch(`/api/assessment-areas/reorder?course=${courseName}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ from: index, to: index - 1 })
            });
            loadAreas();
          }
        } else if (btn.classList.contains('moveDownBtn')) {
          if (index < areaList.children.length - 1) {
            await fetch(`/api/assessment-areas/reorder?course=${courseName}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ from: index, to: index + 1 })
            });
            loadAreas();
          }
        }
      });

      areaList.addEventListener('change', async (e) => {
        // We only care about changes to text inputs
        if (!e.target.matches('.area-name-input, .area-desc-input')) return;

        const input = e.target;
        const index = parseInt(input.dataset.index);
        const listItem = input.closest('li');
        const nameInput = listItem.querySelector('.area-name-input');
        const descInput = listItem.querySelector('.area-desc-input');

        const name = nameInput.value.trim();
        const description = descInput.value.trim();

        if (name) {
          await fetch(`/api/assessment-areas/${index}?course=${courseName}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
          });
        } else {
          showToast('Omr√•desnamnet f√•r inte vara tomt.', true);
          loadAreas(); // Reload to restore original value
        }
      });

      addAreaBtn.addEventListener('click', async () => {
        const name = newAreaNameInput.value.trim();
        const description = newAreaDescInput.value.trim();
        if (!name) return showToast('Ange ett namn!', true);
        await fetch(`/api/assessment-areas?course=${courseName}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        newAreaNameInput.value = '';
        newAreaDescInput.value = '';
        loadAreas();
      });

      deleteCourseBtn.addEventListener('click', async () => {
        if (confirm(`√Ñr du s√§ker p√• att du vill radera kursen "${courseName}"? Denna √•tg√§rd kan inte √•ngras.`)) {
          const res = await fetch(`/api/courses/${courseName}`, { method: 'DELETE' });
          if (res.ok) {
            window.location.href = '/landing.html';
          } else {
            showToast('Kunde inte ta bort kursen.', true);
          }
        }
      });

      async function loadCourseSettings() {
        const res = await fetch(`/api/courses?course=${courseName}`);
        const courses = await res.json();
        const currentCourse = courses.find(c => c.name === courseName);
        if (currentCourse) {
          courseDisplayNameInput.value = currentCourse.displayName || '';
          selectedColor = currentCourse.color || '';
          // Highlight the selected color swatch
          document.querySelectorAll('.color-swatch').forEach(s => {
            s.classList.remove('active');
            if (s.dataset.color === selectedColor) {
              s.classList.add('active');
            }
          });
        }
      }

      saveCourseSettingsBtn.addEventListener('click', async () => {
        const newDisplayName = courseDisplayNameInput.value.trim();
        const newColor = selectedColor; // Use the selectedColor variable

        if (!newDisplayName) {
          return showToast('Visningsnamn f√•r inte vara tomt!', true);
        }
        const res = await fetch(`/api/courses/${courseName}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            newCourseName: courseName, // The actual directory name doesn't change here
            newDisplayName: newDisplayName,
            newColor: newColor
          })
        });

        if (res.ok) {
          showToast('Kursinst√§llningar sparade!');
          // Update page title and back link if display name changed
          document.title = `Admin: ${newDisplayName}`;
          document.getElementById('course-title').textContent = `Admin: ${newDisplayName}`;
        } else {
          showToast('Kunde inte spara kursinst√§llningar.', true);
        }
      });

      // --- Initial Load ---
      function init() {
        loadStudents();
        loadAreas();
        createColorSwatches(); // Create swatches on init
        loadCourseSettings();
      }

      init();
    });
  </script>
</body>
</html>